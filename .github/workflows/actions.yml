name: Actions

on:
  push:
    branches:
    - main
    - 'test-gha-2.*'
    tags:
    - 'test-gha-2.*'
  pull_request:
    branches:
    - main
    - 'test-gha-2.*'

jobs:

  scope:
    name: get scope
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
    - name: Generate tag
      id: tag
      run: echo "tag=$(CI_FORCE_CLEAN=1 bin/root-tag)" >> "$GITHUB_OUTPUT"

    - name: get scope
      run: |
        scope="unknown"
        if [ ${{ github.event_name }} == "pull_request" ]; then
          # pr
          scope=${{github.base_ref}}
        elif [ ${{ github.event_name }} == "push" ]; then
          if [[ ${{ github.ref }} == refs/heads/* ]]; then
            # merge
            # "ref": "refs/heads/test-gha-2.02",
            scope=${${{github.ref}}#refs/heads/}
          elif [[ ${{ github.ref }} == refs/tags/* ]]; then
            # tag
            # "ref": "refs/tags/test-gha-2.02-tag1",
            scope=${{ steps.tag.outputs.tag }}
          fi
        fi

        echo Scope: $scope

  dump:
    name: dump info
    runs-on: ubuntu-22.04
    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"
    - name: Dump Job context
      env:
        JOB_CONTEXT: ${{ toJson(job) }}
      run: echo "$JOB_CONTEXT"
